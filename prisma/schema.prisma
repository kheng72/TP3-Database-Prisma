// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


model User {
  id        Int          @id @default(autoincrement())
  username  String       @unique @db.VarChar(50)
  password  String       @db.VarChar(255)
  lineUid   String?      @unique @map("line_uid") @db.VarChar(100)
  role      String       @db.VarChar(20) // admin | user

  attendances Attendance[]

  @@map("users")
}

model Subject {
  id       Int            @id @default(autoincrement())
  name     String         @db.VarChar(255)
  period   String?        @db.VarChar(50)

  sessions ClassSession[]
}

model Room {
  id        Int          @id @default(autoincrement())
  roomName  String       @map("room_name") @db.VarChar(100)

  device    DeviceIoT?
  sessions  ClassSession[]
}

model DeviceIoT {
  id          Int     @id @default(autoincrement())
  roomId      Int     @unique @map("room_id")
  deviceName  String? @map("device_name") @db.VarChar(100)

  room        Room    @relation(fields: [roomId], references: [id])
  sessions    ClassSession[]
}

model ClassSession {
  id           Int        @id @default(autoincrement())
  subjectId    Int        @map("subject_id")
  roomId       Int        @map("room_id")
  deviceId     Int        @map("device_id")

  qrToken      String     @unique @map("qr_token") @db.VarChar(255)
  startTime    DateTime   @map("start_time")
  endTime      DateTime   @map("end_time")
  maxStudents  Int        @map("max_students")

  subject      Subject    @relation(fields: [subjectId], references: [id])
  room         Room       @relation(fields: [roomId], references: [id])
  device       DeviceIoT  @relation(fields: [deviceId], references: [id])

  attendances  Attendance[]
}

model Attendance {
  id              Int          @id @default(autoincrement())
  userId          Int          @map("user_id")
  classSessionId  Int          @map("class_session_id")

  checkinTime     DateTime     @map("checkin_time")
  status          String?      @db.VarChar(20)

  user            User         @relation(fields: [userId], references: [id])
  classSession    ClassSession @relation(fields: [classSessionId], references: [id])

  @@unique([userId, classSessionId])
}
